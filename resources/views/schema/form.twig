{% extends "page.twig" %}

{% block content %}

  <div class="ibox float-e-margins">
    <div class="ibox-title">
      <h5>Edit {{ schema.title }}</h5>
    </div>

    <div class="ibox-content">
      <form enctype="multipart/form-data" class="form-horizontal" action="/schemas/{{ schema.id }}/edit/" method="post">
        {{ csrf_field() }}

        <div class="tabs-container">
          <ul class="nav nav-tabs">
              <li class="active"><a data-toggle="tab" href="#tab-settings">Schema settings</a></li>
              <li class=""><a data-toggle="tab" href="#tab-fields">Schema fields</a></li>
          </ul>

          <div class="tab-content">

            <div class="tab-pane tab-pane-padding active" id="tab-settings">
              <div class="form-group">
                <label class="col-sm-2 control-label">Title</label>
                <div class="col-sm-10">
                  <input name="title" id="title" type="text" class="form-control" value="{{ schema.title }}">
                </div>
              </div>
            </div>

            <div class="tab-pane tab-pane-padding" id="tab-fields">
              <div class="button-group">
                <button class="btn btn-primary btn-sm" data-add-row>Add new field</button>
              </div>

              <table class="table schema-fields-table">
                <thead>
                  <th>Name</th>
                  <th>Title</th>
                  <th>Type</th>
                  <th class="text-center">Localized</th>
                </thead>
                <tbody>
                  {% for field in schema.fields %}
                    <tr data-id="{{ field.name }}">
                      <td contenteditable>{{ field.name }}</td>
                      <td contenteditable>{{ field.title }}</td>
                      <td>
                        <select class="form-control">
                          {% for type in fieldTypes %}
                            {% if field.type == type %}
                              <option value="{{ type }}" selected>{{ type }}</option>
                            {% else %}
                              <option value="{{ type }}">{{ type }}</option>
                            {% endif %}
                          {% endfor %}
                        </select>
                      </td>
                      <td class="text-center">
                        {% if (field.localized) %}
                          <input class="tableCheckbox" type="checkbox" checked=""/>
                        {% else %}
                          <input class="tableCheckbox" type="checkbox" />
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

          </div>
        </div>

        <hr/>

        <button type="submit" class="btn btn-primary">Save schema</button>
        <button type="submit" class="btn btn-primary">Apply changes</button>

        <a href="/schemas/" class="btn btn-default pull-right">Back</a>
      </form>
    </div>
  </div>
{% endblock %}

{% block additionalJs %}
  <script type="text/javascript">
    $('[data-add-row]').on('click', function(){
      var table = $('table tbody');
      var tr = table.find('tr:last').clone();
      tr.find('td').eq(0).text('New');
      tr.find('td').eq(1).text('');
      tr.find('td').eq(2).find('select').val('Text');
      tr.find('td').eq(3).find('input').prop('checked', false);
      tr.appendTo(table);
      return false;
    });
    $('form').on('submit', function(){
      var data = {};
      data.fields = {};
      var form = $(this);
      form.find('input').each(function(){
        if (!$(this).hasClass('tableCheckbox')){
          data[$(this).attr('name')] = $(this).val();
        }
      });

      var table = $('table tbody');
      table.find('tr').each(function(){
        var index = $(this).data('id');
        data.fields[index] = {
          name: $(this).find('td').eq(0).text(),
          title: $(this).find('td').eq(1).text(),
          type: $(this).find('td').eq(2).find('select').val(),
          localized: $(this).find('td').eq(3).find('input:checked').length > 0
        }
      });

      $.ajax({
        type: "POST",
        url: "/schemas/{{ schema.id }}/edit/",
        data: data,
        dataType: 'json',
        success: function(msg){
          document.location.reload();
        }
      });

      return false;
    })
  </script>
{% endblock %}